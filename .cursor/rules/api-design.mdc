---
description: FastAPI patterns for minimal REST API backends
globs: ["**/api/**/*.py", "**/main.py"]
alwaysApply: false
---

# API Design Standards

## Core Philosophy: Simple and Direct

This is a **minimal FastAPI backend** with a single endpoint. Keep it simple:

1. **Pydantic Models** → Request/Response schemas
2. **OpenAPI Metadata** → Document your endpoint
3. **Error Handling** → Use HTTPException
4. **CORS Configuration** → Allow frontend communication

---

## 1. Pydantic Request/Response Models

```python
from pydantic import BaseModel, Field

class ChatRequest(BaseModel):
    """Request schema for chat endpoint."""
    message: str = Field(min_length=1, max_length=1000, description="User message")

class ChatResponse(BaseModel):
    """Response schema for chat endpoint."""
    reply: str = Field(description="AI-generated response")
```

### Validation Patterns

```python
from pydantic import BaseModel, Field, field_validator

class ChatRequest(BaseModel):
    message: str = Field(min_length=1, max_length=1000)

    @field_validator('message')
    @classmethod
    def message_not_empty(cls, v: str) -> str:
        """Ensure message is not just whitespace."""
        if not v.strip():
            raise ValueError('Message cannot be empty')
        return v.strip()
```

---

## 2. Endpoint Implementation

### Basic POST Endpoint

```python
from fastapi import FastAPI, HTTPException, status
from pydantic import BaseModel

app = FastAPI(title="My API", version="1.0.0")

class ChatRequest(BaseModel):
    message: str

class ChatResponse(BaseModel):
    reply: str

@app.post(
    "/api/chat",
    response_model=ChatResponse,
    status_code=status.HTTP_200_OK,
    summary="Chat with AI",
    description="Send a message and receive an AI-generated response.",
    responses={
        200: {"description": "Successful response"},
        400: {"description": "Invalid request"},
        500: {"description": "Server error"}
    }
)
def chat(request: ChatRequest) -> ChatResponse:
    """Process chat message and return response."""
    try:
        # Your logic here
        reply = process_message(request.message)
        return ChatResponse(reply=reply)
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"Error processing message: {str(e)}"
        )
```

### Health Check Endpoint

```python
@app.get("/")
def health_check():
    """Simple health check endpoint."""
    return {"status": "ok"}
```

---

## 3. Error Handling

### Standard Error Pattern

```python
from fastapi import HTTPException, status

# Client errors (4xx)
if not valid_input:
    raise HTTPException(
        status_code=status.HTTP_400_BAD_REQUEST,
        detail="Invalid input provided"
    )

# Server errors (5xx)
if service_unavailable:
    raise HTTPException(
        status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
        detail="Service temporarily unavailable"
    )
```

### Error Response Example

```python
from fastapi import FastAPI, HTTPException, Request
from fastapi.responses import JSONResponse

app = FastAPI()

@app.exception_handler(HTTPException)
async def http_exception_handler(request: Request, exc: HTTPException):
    """Custom error response format."""
    return JSONResponse(
        status_code=exc.status_code,
        content={
            "error": exc.detail,
            "status_code": exc.status_code
        }
    )
```

---

## 4. CORS Configuration

### Allow Frontend Access

```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI()

# Development: Allow all origins
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"]
)

# Production: Restrict to specific frontend
app.add_middleware(
    CORSMiddleware,
    allow_origins=["https://your-frontend.vercel.app"],
    allow_methods=["POST", "GET"],
    allow_headers=["*"]
)
```

---

## 5. Environment Configuration

### Using python-dotenv

```python
import os
from dotenv import load_dotenv

load_dotenv()

API_KEY = os.getenv("OPENAI_API_KEY")

if not API_KEY:
    raise ValueError("OPENAI_API_KEY environment variable not set")
```

---

## 6. OpenAPI Documentation

FastAPI automatically generates interactive docs at `/docs` and `/redoc`.

### Customize API Metadata

```python
from fastapi import FastAPI

app = FastAPI(
    title="Santa's Chat API",
    description="Chat with St. Nicholas powered by AI",
    version="1.0.0",
    contact={
        "name": "Your Name",
        "email": "you@example.com"
    }
)
```

---

## DO NOT

- ❌ Skip Pydantic models and return raw dicts
- ❌ Use generic error messages without details
- ❌ Forget CORS middleware for frontend access
- ❌ Hardcode API keys in code (use environment variables)
- ❌ Skip OpenAPI metadata (summary, description, responses)
- ❌ Over-engineer with unnecessary abstractions for a simple endpoint
